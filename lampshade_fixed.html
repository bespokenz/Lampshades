<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bespoke Shade Maker – Lampshade Pattern PWA</title>
  <meta name="theme-color" content="#2b6cb0">
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    :root{--bg:#f7fbff;--card:#fff;--accent:#2b6cb0;--muted:#637381}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans',sans-serif;background:var(--bg);color:#0b1220;font-size:20px;touch-action:manipulation}
    .wrap{max-width:800px;margin:8px auto;padding:8px}
    header{display:flex;gap:12px;align-items:center}
    h1{margin:0;font-size:22px}
    .card{background:var(--card);border-radius:12px;padding:10px;box-shadow:0 3px 10px rgba(11,18,32,.10);margin-bottom:10px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    label{display:block;font-size:15px;color:var(--muted);margin-bottom:6px}
    input[type=number],select{width:100%;padding:14px 8px;border-radius:8px;border:1px solid #e6eef6;font-size:18px}
    .row{display:flex;gap:8px}
    .small{width:120px}
    .controls{display:flex;gap:8px;align-items:center;margin-top:14px;flex-wrap:wrap;}
    button{background:var(--accent);border:none;color:white;padding:18px 0;border-radius:8px;font-weight:600;cursor:pointer;font-size:18px;width:100%;margin-top:8px;touch-action:manipulation}
    button:disabled{background:#ccc;cursor:not-allowed}
    .footer,.info{font-size:15px;color:var(--muted);margin-top:12px}
    .status{padding:10px;margin-top:10px;border-radius:8px;font-size:15px;display:none}
    .status.show{display:block}
    .status.success{background:#d4edda;color:#155724}
    .status.error{background:#f8d7da;color:#721c24}
    .status.info{background:#d1ecf1;color:#0c5460}
    @media (max-width:700px){body{font-size:22px;}.wrap{max-width:none;margin:0;padding:0}.grid{grid-template-columns:1fr}.card{padding:8px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="card" style="display:inline-flex;padding:10px 14px;align-items:center;gap:12px">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden>
          <path d="M12 2l2.5 5 5.5 1-4 4 1 5.5L12 16l-5 3.5L8 12 4 8l5.5-1L12 2z" fill="#2b6cb0" />
        </svg>
        <div>
          <h1>Bespoke Shade Maker</h1>
          <div style="font-size:13px;color:var(--muted)">Create printable lampshade templates – PWA-ready</div>
        </div>
      </div>
      <div style="flex:1"></div>
    </header>
    <div class="grid">
      <div class="card">
        <h2 style="margin:0 0 8px 0">Inputs</h2>
        <div style="display:grid;gap:10px">
          <div>
            <label>Units</label>
            <div class="row">
              <select id="unit">
                <option value="mm">Millimetres (mm)</option>
                <option value="in">Inches (in)</option>
              </select>
              <div style="display:flex;align-items:center;margin-left:6px;color:var(--muted);font-size:15px">Toggle units – inputs update</div>
            </div>
          </div>
          <div class="row">
            <div style="flex:1">
              <label>Top diameter</label>
              <input id="topD" type="number" step="0.1" min="1" value="150" />
            </div>
            <div style="flex:1">
              <label>Bottom diameter</label>
              <input id="botD" type="number" step="0.1" min="1" value="300" />
            </div>
          </div>
          <div>
            <label>Height (vertical)</label>
            <input id="height" type="number" step="0.1" min="1" value="220" />
          </div>
          <div class="row">
            <div style="flex:1">
              <label>Seam allowance (along straight edge)</label>
              <input id="seam" type="number" step="0.1" min="0" value="10" />
            </div>
            <div style="flex:1">
              <label>Bend allowance (top/bottom fold)</label>
              <input id="fold" type="number" step="0.1" min="0" value="8" />
            </div>
          </div>
          <div>
            <label>Scale to fit page width when printing</label>
            <select id="paperScale">
              <option value="fit">Fit to page width (A4/Letter)</option>
              <option value="1">1:1 (actual size)</option>
              <option value="0.5">50%</option>
            </select>
          </div>
          <div class="controls">
            <button id="openPdfBtn" style="width:32%;">Open PDF</button>
            <button id="printPdfBtn" style="width:32%;">Print PDF</button>
            <button id="downloadPdfBtn" style="width:32%;">Download PDF</button>
          </div>
          <div id="statusMsg" class="status"></div>
          <div class="info">
            This generator calculates the unwrapped lateral surface of a lampshade (truncated cone). The template will be exported as a printable, multipage PDF, ready for assembly. Mathematical notes are shown on the template.
          </div>
        </div>
      </div>
    </div>
    <footer style="margin-top:14px;text-align:center;color:var(--muted);font-size:13px">Offline-capable PWA – add to home screen to install.</footer>
  </div>
  <script>
    // Status message helper
    function showStatus(msg, type = 'info') {
      const statusEl = document.getElementById('statusMsg');
      statusEl.textContent = msg;
      statusEl.className = 'status show ' + type;
      setTimeout(() => {
        statusEl.classList.remove('show');
      }, 5000);
    }

    // Disable/enable buttons
    function setButtonsEnabled(enabled) {
      document.getElementById('openPdfBtn').disabled = !enabled;
      document.getElementById('printPdfBtn').disabled = !enabled;
      document.getElementById('downloadPdfBtn').disabled = !enabled;
    }

    // --- PDF + Geometry Utilities ---
    function toMM(value, unit){ return unit === 'mm' ? Number(value) : Number(value) * 25.4 }
    function fromMM(value, unit){ return unit === 'mm' ? value : value / 25.4 }
    function computeAnnularSector(r1, r2, h){
      if (r2 === r1) r2 = r1 + 0.00001;
      const s = Math.sqrt((r2 - r1) * (r2 - r1) + h * h);
      const L2 = s * r2 / (r2 - r1);
      const L1 = s * r1 / (r2 - r1);
      const theta = 2 * Math.PI * (r2 - r1) / s;
      return {s, L1, L2, theta};
    }
    function polarToCartesian(r, angle, cx, cy){
      return {x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle)};
    }

    async function generatePdfBlob() {
      const unit = document.getElementById('unit').value;
      const topD = Number(document.getElementById('topD').value);
      const botD = Number(document.getElementById('botD').value);
      const height = Number(document.getElementById('height').value);
      const seam = Number(document.getElementById('seam').value);
      const fold = Number(document.getElementById('fold').value);
      const paperScale = document.getElementById('paperScale').value;

      // Validate inputs
      if (!topD || !botD || !height || topD <= 0 || botD <= 0 || height <= 0) {
        throw new Error('Invalid dimensions. Please check your inputs.');
      }

      // Wait for pdf-lib with better error handling
      let PDFLib = window.PDFLib || window.pdfLib;
      if (!PDFLib) {
        await new Promise(resolve => setTimeout(resolve, 500));
        PDFLib = window.PDFLib || window.pdfLib;
      }
      
      if (!PDFLib || !PDFLib.PDFDocument) {
        throw new Error('PDF library not loaded. Please refresh the page.');
      }

      const { PDFDocument, rgb } = PDFLib;
      const pdfDoc = await PDFDocument.create();

      // PDF: A4 (595x842pt)
      const pageWidth = 595, pageHeight = 842, marginPt = 28;
      const mmToPt = 72 / 25.4;

      // Geometry calculations in mm
      const topR = toMM(topD / 2, unit), botR = toMM(botD / 2, unit), h = toMM(height, unit);
      const seamMM = toMM(seam, unit), foldMM = toMM(fold, unit);
      const geom = computeAnnularSector(topR, botR, h);
      
      const rInnerMM = geom.L1 + foldMM;
      const rOuterMM = geom.L2 + foldMM + seamMM;
      const angleSpan = geom.theta;

      // Convert to points
      const rInnerPt = rInnerMM * mmToPt;
      const rOuterPt = rOuterMM * mmToPt;

      // Full drawing size
      const headerHeight = 40;
      const contentWidthPt = Math.ceil(2 * rOuterPt);
      const contentHeightPt = Math.ceil(2 * rOuterPt);
      const fullWidthPt = contentWidthPt + marginPt * 2;
      const fullHeightPt = headerHeight + contentHeightPt + marginPt * 2 + 20;

      // Compute scale
      let userScale = 1;
      if (paperScale === '0.5') userScale = 0.5;
      else if (paperScale === '1') userScale = 1;
      else if (paperScale === 'fit') {
        const printableWidth = pageWidth - marginPt * 2;
        userScale = Math.min(1, printableWidth / fullWidthPt);
      }

      // Use lower DPR for Android performance (max 2)
      const dpr = Math.min(window.devicePixelRatio || 1, 2);

      const fullCanvasWpx = Math.max(1, Math.ceil(fullWidthPt * userScale * dpr));
      const fullCanvasHpx = Math.max(1, Math.ceil(fullHeightPt * userScale * dpr));

      // Create offscreen canvas
      const fullCanvas = document.createElement('canvas');
      fullCanvas.width = fullCanvasWpx;
      fullCanvas.height = fullCanvasHpx;

      const fctx = fullCanvas.getContext('2d', { alpha: false, willReadFrequently: true });
      if (!fctx) {
        throw new Error('Could not create canvas context');
      }

      // Scale transform
      fctx.setTransform(userScale * dpr, 0, 0, userScale * dpr, 0, 0);

      // White background
      fctx.fillStyle = '#ffffff';
      fctx.fillRect(0, 0, fullWidthPt, fullHeightPt);

      // Title
      fctx.fillStyle = '#1f2d55';
      fctx.font = '16px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial';
      fctx.fillText('Lampshade Template', marginPt, 28);

      // Center for sector
      const cx = marginPt + rOuterPt;
      const cy = marginPt + headerHeight + rOuterPt;

      // Draw annular sector
      const steps = Math.max(120, Math.floor((angleSpan / (Math.PI * 2)) * 360));
      fctx.beginPath();
      for (let i = 0; i <= steps; i++) {
        const t = -angleSpan / 2 + (angleSpan) * (i / steps);
        const p = polarToCartesian(rOuterPt, t, cx, cy);
        if (i === 0) fctx.moveTo(p.x, p.y); else fctx.lineTo(p.x, p.y);
      }
      for (let i = steps; i >= 0; i--) {
        const t = -angleSpan / 2 + (angleSpan) * (i / steps);
        const p = polarToCartesian(rInnerPt, t, cx, cy);
        fctx.lineTo(p.x, p.y);
      }
      fctx.closePath();
      fctx.fillStyle = '#ffffff';
      fctx.fill();
      fctx.lineWidth = 2;
      fctx.strokeStyle = '#2b6cb0';
      fctx.stroke();

      // Dashed cut lines
      const startAngle = -angleSpan / 2;
      const endAngle = angleSpan / 2;
      const startPtOut = polarToCartesian(rOuterPt, startAngle, cx, cy);
      const startPtIn = polarToCartesian(rInnerPt, startAngle, cx, cy);
      const endPtOut = polarToCartesian(rOuterPt, endAngle, cx, cy);
      const endPtIn = polarToCartesian(rInnerPt, endAngle, cx, cy);

      fctx.setLineDash([6, 4]);
      fctx.strokeStyle = 'rgba(200,40,40,0.95)';
      fctx.lineWidth = 1.5;
      fctx.beginPath();
      fctx.moveTo(startPtOut.x, startPtOut.y);
      fctx.lineTo(startPtIn.x, startPtIn.y);
      fctx.stroke();

      fctx.beginPath();
      fctx.moveTo(endPtOut.x, endPtOut.y);
      fctx.lineTo(endPtIn.x, endPtIn.y);
      fctx.stroke();
      fctx.setLineDash([]);

      // Labels
      fctx.fillStyle = 'rgba(60,10,40,0.8)';
      fctx.font = '10px system-ui, sans-serif';
      fctx.fillText(`Outer radius: ${fromMM(rOuterMM, unit).toFixed(2)} ${unit}`, marginPt, fullHeightPt - marginPt - 8);
      fctx.fillText(`Inner radius: ${fromMM(rInnerMM, unit).toFixed(2)} ${unit}`, marginPt, fullHeightPt - marginPt - 22);
      fctx.fillText(`Sector angle: ${(geom.theta * 180 / Math.PI).toFixed(2)}°`, marginPt, fullHeightPt - marginPt - 36);

      // Slice into pages
      const marginPx = marginPt * userScale * dpr;
      const tileWpx = Math.floor((pageWidth - marginPt * 2) * userScale * dpr);
      const tileHpx = Math.floor((pageHeight - marginPt * 2) * userScale * dpr);

      const effectiveTileW = Math.max(1, tileWpx);
      const effectiveTileH = Math.max(1, tileHpx);

      let pageNum = 1;
      for (let y = 0; y < fullCanvas.height; y += effectiveTileH) {
        for (let x = 0; x < fullCanvas.width; x += effectiveTileW) {
          const pageCanvas = document.createElement('canvas');
          pageCanvas.width = Math.ceil(pageWidth * dpr);
          pageCanvas.height = Math.ceil(pageHeight * dpr);
          
          const pctx = pageCanvas.getContext('2d', { alpha: false });
          if (!pctx) continue;

          // White background
          pctx.fillStyle = '#ffffff';
          pctx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);

          const srcW = Math.min(effectiveTileW, fullCanvas.width - x);
          const srcH = Math.min(effectiveTileH, fullCanvas.height - y);

          // Draw tile
          pctx.drawImage(
            fullCanvas,
            x, y, srcW, srcH,
            marginPx, marginPx, srcW, srcH
          );

          // Page label
          pctx.fillStyle = 'rgba(0,0,0,0.65)';
          pctx.font = Math.round(10 * dpr) + 'px system-ui, sans-serif';
          pctx.fillText(`Pg ${pageNum}`, marginPx + 4, 18 * dpr);

          // Convert to PNG and embed - Fixed method
          const pngDataUrl = pageCanvas.toDataURL('image/png', 0.92);
          const base64Data = pngDataUrl.split(',')[1];
          const pngImage = await pdfDoc.embedPng(base64Data);
          
          const page = pdfDoc.addPage([pageWidth, pageHeight]);
          page.drawImage(pngImage, {
            x: 0,
            y: 0,
            width: pageWidth,
            height: pageHeight
          });

          pageNum++;
        }
      }

      const pdfBytes = await pdfDoc.save();
      return new Blob([pdfBytes], { type: 'application/pdf' });
    }

    async function openPdf() {
      try {
        setButtonsEnabled(false);
        showStatus('Generating PDF...', 'info');
        
        const blob = await generatePdfBlob();
        const url = URL.createObjectURL(blob);
        
        // Try opening in new tab
        const newWindow = window.open(url, '_blank');
        
        if (!newWindow) {
          // Fallback to download if popup blocked
          const a = document.createElement('a');
          a.href = url;
          a.download = 'lampshade-template.pdf';
          document.body.appendChild(a);
          a.click();
          a.remove();
          showStatus('Popup blocked. PDF downloaded instead.', 'success');
        } else {
          showStatus('PDF opened successfully!', 'success');
        }
        
        setTimeout(() => URL.revokeObjectURL(url), 60000);
      } catch (err) {
        console.error('Open PDF error:', err);
        showStatus('Error: ' + err.message, 'error');
      } finally {
        setButtonsEnabled(true);
      }
    }

    async function printPdf() {
      try {
        setButtonsEnabled(false);
        showStatus('Generating PDF for printing...', 'info');
        
        const blob = await generatePdfBlob();
        const url = URL.createObjectURL(blob);
        
        // Android-friendly: direct download with instruction
        if (/android/i.test(navigator.userAgent)) {
          const a = document.createElement('a');
          a.href = url;
          a.download = 'lampshade-template.pdf';
          document.body.appendChild(a);
          a.click();
          a.remove();
          showStatus('PDF downloaded. Open it and use your device\'s print function.', 'success');
          setTimeout(() => URL.revokeObjectURL(url), 60000);
          return;
        }
        
        // Desktop: open in new window for printing
        const printWindow = window.open(url, '_blank');
        if (!printWindow) {
          const a = document.createElement('a');
          a.href = url;
          a.download = 'lampshade-template.pdf';
          document.body.appendChild(a);
          a.click();
          a.remove();
          showStatus('Popup blocked. PDF downloaded for printing.', 'success');
        } else {
          showStatus('PDF opened. Use browser print dialog.', 'success');
        }
        
        setTimeout(() => URL.revokeObjectURL(url), 120000);
      } catch (err) {
        console.error('Print PDF error:', err);
        showStatus('Error: ' + err.message, 'error');
      } finally {
        setButtonsEnabled(true);
      }
    }

    async function downloadPdf() {
      try {
        setButtonsEnabled(false);
        showStatus('Generating PDF...', 'info');
        
        const blob = await generatePdfBlob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'lampshade-template.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        
        showStatus('PDF downloaded successfully!', 'success');
        setTimeout(() => URL.revokeObjectURL(url), 60000);
      } catch (err) {
        console.error('Download PDF error:', err);
        showStatus('Error: ' + err.message, 'error');
      } finally {
        setButtonsEnabled(true);
      }
    }

    document.getElementById('openPdfBtn').addEventListener('click', openPdf);
    document.getElementById('printPdfBtn').addEventListener('click', printPdf);
    document.getElementById('downloadPdfBtn').addEventListener('click', downloadPdf);

    // PWA service worker
    const swScript = `self.addEventListener('install', event => { self.skipWaiting(); });
      self.addEventListener('activate', event => { event.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', event => { event.respondWith(fetch(event.request).catch(()=>caches.match(event.request))); });`;
    if ('serviceWorker' in navigator){
      const blob = new Blob([swScript],{type:'application/javascript'});
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).then(()=>console.log('SW registered')).catch(()=>console.log('SW registration failed'));
    }
  </script>
</body>
</html>